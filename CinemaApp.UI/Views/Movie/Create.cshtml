@model CinemaApp.BL.DTOs.MovieDTOs.Movie.MovieCreateDTO

<h2>Add New Film</h2>

<form asp-action="Create" method="post" class="needs-validation" novalidate>
    <div class="mb-3">
        <label asp-for="Title" class="form-label"></label>
        <input asp-for="Title" class="form-control" required />
        <div class="invalid-feedback">Please provide a title.</div>
        <span asp-validation-for="Title" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Description" class="form-label"></label>
        <textarea asp-for="Description" class="form-control" required></textarea>
        <div class="invalid-feedback">Please provide a description.</div>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="GenreID" class="control-label">Genre </label>
        <select asp-for="GenreID" class="form-control">
            <option value="">-- Select Genre --</option>
            @if (ViewBag.Genres != null)
            {
                foreach (var genre in ViewBag.Genres)
                {
                    <option value="@genre.GenreID">@genre.GenreName</option>
                }
            }
        </select>
        <span asp-validation-for="GenreID1" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="GenreID1" class="control-label">Genre 1</label>
        <select asp-for="GenreID1" class="form-control">
            <option value="">-- Select Genre --</option>
            @if (ViewBag.Genres != null)
            {
                foreach (var genre in ViewBag.Genres)
                {
                    <option value="@genre.GenreID">@genre.GenreName</option>
                }
            }
        </select>
        <span asp-validation-for="GenreID1" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="GenreID2" class="control-label">Genre 2</label>
        <select asp-for="GenreID2" class="form-control">
            <option value="">-- Select Genre --</option>
            @if (ViewBag.Genres != null)
            {
                foreach (var genre in ViewBag.Genres)
                {
                    <option value="@genre.GenreID">@genre.GenreName</option>
                }
            }
        </select>
        <span asp-validation-for="GenreID2" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="GenreID3" class="control-label">Genre 3</label>
        <select asp-for="GenreID3" class="form-control">
            <option value="">-- Select Genre --</option>
            @if (ViewBag.Genres != null)
            {
                foreach (var genre in ViewBag.Genres)
                {
                    <option value="@genre.GenreID">@genre.GenreName</option>
                }
            }
        </select>
        <span asp-validation-for="GenreID3" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="GenreID4" class="control-label">Genre 4</label>
        <select asp-for="GenreID4" class="form-control">
            <option value="">-- Select Genre --</option>
            @if (ViewBag.Genres != null)
            {
                foreach (var genre in ViewBag.Genres)
                {
                    <option value="@genre.GenreID">@genre.GenreName</option>
                }
            }
        </select>
        <span asp-validation-for="GenreID4" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Duration" class="form-label"></label>
        <input asp-for="Duration" class="form-control" type="time" required />
        <div class="invalid-feedback">Please provide a duration.</div>
        <span asp-validation-for="Duration" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="ReleaseDate" class="form-label"></label>
        <input asp-for="ReleaseDate" class="form-control" type="date" required />
        <div class="invalid-feedback">Please provide a release date.</div>
        <span asp-validation-for="ReleaseDate" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Rating" class="form-label"></label>
        <input asp-for="Rating" class="form-control" required />
        <div class="invalid-feedback">Please provide a rating.</div>
        <span asp-validation-for="Rating" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="AgeLimit" class="form-label"></label>
        <input asp-for="AgeLimit" class="form-control" required />
        <div class="invalid-feedback">Please provide an age limit.</div>
        <span asp-validation-for="AgeLimit" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="PosterURL" class="form-label"></label>
        <input asp-for="PosterURL" class="form-control" required />
        <div class="invalid-feedback">Please provide a poster URL.</div>
        <span asp-validation-for="PosterURL" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="TrailerURL" class="form-label"></label>
        <input asp-for="TrailerURL" class="form-control" required />
        <div class="invalid-feedback">Please provide a trailer URL.</div>
        <span asp-validation-for="TrailerURL" class="text-danger"></span>
    </div>

    <h3>Crewmates</h3>
    <table class="table" id="crewmateTable">
        <thead>
            <tr>
                <th>Crewmate ID</th>
                <th>Position ID</th>
                <th>Crewmate</th>
                <th>Position</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <input type="number" name="MovieCrewmates[0].CrewmateID" class="form-control crewmate-id" required />
                </td>
                <td>
                    <input type="number" name="MovieCrewmates[0].PositionID" class="form-control position-id" required />
                </td>
                <td class="crewmate-name"></td>
                <td class="position-name"></td>
                <td>
                    <button type="button" class="btn btn-danger remove-actor">Delete</button>
                </td>
            </tr>
        </tbody>
    </table>
    <button type="button" class="btn btn-success" id="addActor">Add crewmate</button>

    <div class="mb-3 mt-3">
        <input type="submit" value="Add" class="btn btn-primary" />
        <a asp-action="Index" class="btn btn-secondary">Back to list</a>
    </div>
</form>

<script>
    (function () {
        'use strict';
        const forms = document.querySelectorAll('.needs-validation');

        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                form.classList.add('was-validated');
            }, false);
        });
    })();

    document.getElementById("addActor").addEventListener("click", function () {
        var table = document.getElementById("crewmateTable").getElementsByTagName('tbody')[0];
        var index = table.rows.length;

        var newRow = table.insertRow();
        newRow.innerHTML = `
            <td>
                <input type="number" name="MovieCrewmates[${index}].CrewmateID" class="form-control crewmate-id" required />
            </td>
            <td>
                <input type="number" name="MovieCrewmates[${index}].PositionID" class="form-control position-id" required />
            </td>
            <td class="crewmate-name"></td>
            <td class="position-name"></td>
            <td>
                <button type="button" class="btn btn-danger remove-actor">Delete</button>
            </td>
        `;

        updateRemoveButtons();
        attachPreviewListeners(newRow);
    });

    function updateRemoveButtons() {
        document.querySelectorAll(".remove-actor").forEach(button => {
            button.addEventListener("click", function () {
                this.closest("tr").remove();
            });
        });
    }

    function attachPreviewListeners(row) {
        const crewmateIdInput = row.querySelector(".crewmate-id");
        const positionIdInput = row.querySelector(".position-id");
        const crewmateNameCell = row.querySelector(".crewmate-name");
        const positionNameCell = row.querySelector(".position-name");

        crewmateIdInput.addEventListener("input", async function () {
            const crewmateId = this.value;
            if (crewmateId) {
                const response = await fetch(`/Crewmate/GetCrewmateName?id=${crewmateId}`);
                if (response.ok) {
                    const data = await response.json();
                    crewmateNameCell.textContent = data.name;
                } else {
                    crewmateNameCell.textContent = "Unknown crewmate";
                }
            } else {
                crewmateNameCell.textContent = "";
            }
        });

        positionIdInput.addEventListener("input", async function () {
            const positionId = this.value;
            if (positionId) {
                const response = await fetch(`/Position/GetPositionName?id=${positionId}`);
                if (response.ok) {
                    const data = await response.json();
                    positionNameCell.textContent = data.name;
                } else {
                    positionNameCell.textContent = "Unknown position";
                }
            } else {
                positionNameCell.textContent = "";
            }
        });
    }

    document.querySelectorAll("#crewmateTable tbody tr").forEach(row => {
        attachPreviewListeners(row);
    });

    updateRemoveButtons();
</script>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        <ul>
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>
}
